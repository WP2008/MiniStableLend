# MiniLend-Stable 合约开发 
## 一、核心业务流程

### 1. 基础质押
- 用户向系统存入 ETH，合约铸造等额 stETH（质押凭证）给用户，stETH 自动累计借贷利息收益；
- stETH 可随时赎回为 ETH（无排队机制，赎回后销毁对应 stETH）。

### 2. 超额抵押借贷（mUSD 铸造）
- 用户将持有的 stETH 标记为抵押品；
- 系统根据 ETH 实时价格（Chainlink 喂价）计算可借贷额度：可借 mUSD = stETH 价值 × 66.6%（对应最低抵押率 150%）；
- 用户铸造 mUSD 时，系统收取 0.05%~0.1% 铸币手续费（直接进入项目国库）；
- 成功铸造后，用户债务 = 借出 mUSD 本金，债务按 4% 年化利率累计利息。

### 3. 利息分配
- 用户借贷产生的利息，90% 分配给 stETH 持有者（自动体现在 stETH 净值中）；
- 10% 作为项目方收益，划入国库合约。

### 4. 清算机制
- 当用户抵押率（抵押品价值/债务）低于 110%（清算阈值）时，触发清算；
- 清算人可使用 mUSD 偿还用户部分债务，并以 5% 折扣收购用户对应 stETH（其中 4% 归清算人，1% 归项目国库）；
- 清算后用户抵押率恢复至安全线以上。

### 5. 还款与赎回
- 用户归还 mUSD 本金 + 累计利息，系统销毁对应 mUSD，解除同等金额债务；
- 债务清零后，用户可解锁 stETH 并赎回为 ETH。

## 二、合约架构与核心功能
| 合约名称         | 核心功能                                                                 | 关键特性                                                                 |
|------------------|--------------------------------------------------------------------------|--------------------------------------------------------------------------|
| MiniStETH.sol    | ETH 质押凭证发行、生息、赎回                                             | ERC20 标准，仅 Vault 合约可 mint/burn，无管理员铸币权限                  |
| MiniMUSD.sol     | 稳定币 mUSD 铸造/销毁                                                   | 仅 Vault 合约可操作 mint/burn，无任何后门，完全由抵押品支撑              |
| MiniOracle.sol   | ETH/USD 价格喂价（对接 Chainlink）                                       | 仅 Timelock 可更换喂价地址，价格不可手动篡改                            |
| MiniVault.sol    | 抵押管理、借贷计息、清算执行、手续费分配                                 | 系统核心，集成所有业务逻辑，高危参数需 Timelock 延时修改                |
| MiniTreasury.sol | 项目方收益归集、提取                                                     | 多签权限管理，仅可提取手续费收益，无法触碰用户资产                      |
| TimelockController.sol | 高危参数修改延时管控（OpenZeppelin 开源合约）| 所有参数修改需提前 24~48 小时公示，用户有足够时间应对规则变更           |


```Mermaid
flowchart TD
    A[用户] --> B[1. 存入 ETH]
    B --> C[MiniStETH 铸造 stETH]
    
    C --> D[2. 抵押 stETH 到 Vault]
    D --> E[MiniVault 创建用户仓位]
    
    E --> F[3. 申请借贷 mUSD]
    F --> G{检查抵押率 ≥ 150%?}
    
    G -- 不通过 --> H[拒绝借贷]
    G -- 通过 --> I[铸造 mUSD → 用户]
    I --> J[收取 0.1% 手续费 → 国库]
    
    J --> K[4. 持续计息]
    K --> L[利息 90% → stETH 持有者]
    K --> M[利息 10% → 项目国库]
    
    K --> N{ETH 价格是否暴跌?}
    
    %% 正常流程
    N -- 否 --> O[5. 用户还款 mUSD]
    O --> P[销毁 mUSD，债务减少]
    P --> Q[解锁 stETH]
    Q --> R[赎回 ETH]
    
    %% 清算流程
    N -- 是 --> S{抵押率 &lt; 110%?}
    S -- 是 --> T[触发清算]
    T --> U[清算人还款 + 获得折扣抵押品]
    U --> V[国库抽取 1% 清算收益]
    V --> W[用户抵押率恢复安全]
```


## 三、合约开发任务拆分

### 阶段 1：基础合约开发（核心必备）
#### 任务 1.1：MiniStETH.sol 开发
- 完成 ERC20 基础实现（名称、符号、小数位）；
- 实现 `mint`/`burn` 函数，仅允许 MiniVault 合约调用；
- 增加 `setVault` 函数（仅 Timelock 可调用），绑定业务合约；
- 无管理员手动铸币/转账权限，保障用户资产安全。

#### 任务 1.2：MiniMUSD.sol 开发
- 完成 ERC20 基础实现（名称：Mini USD，符号：mUSD，小数位：18）；
- 实现 `mint`/`burn` 函数，仅允许 MiniVault 合约调用；
- 实现 `setVault` 函数（仅初始化时可设置，不可重复修改）；
- 移除所有管理员对 mUSD 的直接操作权限，杜绝乱印币风险。

#### 任务 1.3：MiniOracle.sol 开发
- 对接 Chainlink ETH/USD 喂价合约（AggregatorV3Interface）；
- 实现 `getETHPrice()` 函数，返回标准化 ETH 价格（8 位小数）；
- 实现 `setFeed()` 函数，仅 Timelock 可修改喂价地址；
- 增加价格有效性校验（排除异常价格）。

### 阶段 2：核心业务合约开发（系统核心）
#### 任务 2.1：MiniVault.sol 基础框架搭建
- 定义核心结构体（用户仓位 Position：collateral/debt/lastUpdate）；
- 绑定外部合约（stETH/mUSD/oracle/treasury/timelock）；
- 初始化全局参数（抵押率、清算阈值、费率等）。

#### 任务 2.2：质押/借贷核心逻辑开发
- 实现 `depositETH()`：用户存入 ETH 并铸造 stETH；
- 实现 `depositCollateral()`：用户质押 stETH 作为抵押品；
- 实现 `_accrueInterest()`：内部计息函数（按时间累计借贷利息）；
- 实现 `borrow()`：校验抵押率后铸造 mUSD，扣除铸币手续费至国库；
- 实现 `repay()`：用户归还 mUSD，销毁代币并减少债务。

#### 任务 2.3：清算逻辑开发
- 实现 `_getHealthFactor()`：计算用户抵押率（健康因子）；
- 实现 `liquidate()`：校验清算条件，执行清算流程（还款→折扣收购抵押品→手续费分配）；
- 增加清算金额限制（单次清算不超过债务的 50%），避免过度清算。

#### 任务 2.4：赎回与权限控制
- 实现 `withdrawCollateral()`：解锁抵押品并赎回 ETH；
- 实现 `setParams()`：仅 Timelock 可修改全局参数（抵押率、费率等）；
- 增加权限校验（所有高危操作仅允许指定合约/角色调用）。

### 阶段 3：配套合约与权限完善
#### 任务 3.1：MiniTreasury.sol 开发
- 实现收益归集（接收铸币手续费、利息抽成、清算抽成）；
- 实现 `withdraw()` 函数：多签权限控制，仅可提取指定代币至指定地址；
- 增加收益明细记录（便于审计和透明化）。

#### 任务 3.2：Timelock 集成
- 部署 OpenZeppelin TimelockController 合约；
- 将 MiniVault/MiniOracle 的参数修改权限转移至 Timelock；
- 配置延时时间（建议 24 小时），设置多签管理员为 Timelock 提案人。

### 阶段 4：安全与测试（上线前必备）
#### 任务 4.1：单元测试编写
- 覆盖核心流程：质押→借贷→计息→清算→还款→赎回；
- 测试异常场景：抵押率不足、清算失败、权限越权等；
- 验证手续费分配、利息计算的准确性。

#### 任务 4.2：安全校验
- 移除所有不必要的管理员权限，杜绝后门；
- 检查重入漏洞（使用 ReentrancyGuard）；
- 校验数值溢出/下溢（Solidity 0.8.x 原生支持，关键逻辑增加边界检查）。

#### 任务 4.3：文档与审计准备
- 补充合约内注释（关键函数、参数、权限）；
- 整理业务逻辑流程图、权限矩阵；
- 输出审计所需的合约说明文档。

## 四、开发约束与核心原则
1. **权限安全**：用户资产相关操作（转账、铸币、销毁）仅允许合约自动执行，管理员无直接操作权限；
2. **参数透明**：所有费率、抵押率、清算规则均写死在合约（或仅 Timelock 可延时修改），无隐藏逻辑；
3. **极简逻辑**：仅保留核心业务流程，不添加无关功能（如闪电贷、多资产支持），降低安全风险；
4. **审计友好**：代码结构清晰，注释完整，关键逻辑单独封装，便于审计机构快速理解。

## 五、部署与上线前置条件
1. 完成所有合约单元测试，核心流程 100% 覆盖；
2. 完成第三方安全审计（重点检查清算逻辑、权限控制、计息公式）；
3. 部署 Timelock 合约并完成权限配置；
4. 配置多签钱包作为 Timelock 提案人，确保管理权不集中；
5. 上线前公示合约代码、参数规则、国库地址，保证透明化。

